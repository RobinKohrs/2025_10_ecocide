---
title: "Ecocide Austria"
format:
  html:
    self-contained: false
    theme: cosmo
    toc: true
    toc-depth: 3
    toc-location: left
    code-fold: true
    code-summary: "Show Code"
editor: source
execute:
  echo: true
  warning: false
  message: false
  freeze: auto
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(tidyverse)
library(here)
library(glue)
library(sf)
library(davR)
library(jsonlite)
library(mapview)
m <- mapview
library(leaflet)
library(DT)
library(crosstalk)


# ++++++++++++++++++++++++++++++
# read in data ----
# ++++++++++++++++++++++++++++++
geo_omv_dafni_8857 <- read_sf("~/Library/Mobile Documents/com~apple~CloudDocs/geodata/projects_data_raw/2025-10-ecocide/data_dafni/Austria-all-blocks.gpkg")

geo_pa_8857 <- read_sf("~/Library/Mobile Documents/com~apple~CloudDocs/geodata/projects_data_raw/2025-10-ecocide/output/wdpa/austria/wdpa_austria_polygons.gpkg") %>%
    st_transform(8857)


# ++++++++++++++++++++++++++++++
# intersections ----
# ++++++++++++++++++++++++++++++
geo_omv_dafni_8857 <- geo_omv_dafni_8857 %>%
    rename_with(~ paste0("ms_", .), .cols = -attr(., "sf_column"))

geo_pa_8857 <- geo_pa_8857 %>%
    rename_with(~ paste0("pa_", .), .cols = -attr(., "sf_column"))

geo_int_blocks_pa <- st_intersection(
    geo_pa_8857,
    geo_omv_dafni_8857
)

geo_int_blocks_pa %>%
    select(
        ms_descriptio,
        ms_name,
        ms_adm_co_gro,
        ms_adm_co_nam,
        ms_admin_area,
        ms_attributio,
        ms_lc_status,
        ms_lc_type,
        ms_mps_create,
        ms_mps_dataso,
        pa_NAME,
        pa_ORIG_NAME,
        pa_DESIG,
        pa_DESIG_ENG,
        pa_DESIG_TYPE,
        pa_IUCN_CAT,
        pa_INT_CRIT,
        pa_GOV_TYPE
    ) -> geo_int_pa_ms_at



# write out intersections
path_out_intersections <- sys_make_path(here("data_output/intersections_mapstand_pa_austria/intersections_mapstand_pa_austria.fgb"))
unlink(path_out_intersections)
write_sf(geo_int_pa_ms_at %>% st_transform(4326), path_out_intersections)

# ++++++++++++++++++++++++++++++
# get only OMV ----
# ++++++++++++++++++++++++++++++
geo_int_pa_ms_at_omv <- geo_int_pa_ms_at %>%
    filter(str_detect(ms_adm_co_gro, "OMV"))
```

```{r}
m(
    geo_omv_dafni_8857,
    col.regions = "#2b2b2b", alpha.regions = 0.4, # boreholes
    layer.name = "Mapstand Data"
) +
    m(
        geo_pa_8857,
        col.regions = "#7d7d7d", alpha.regions = 0.4, # protected areas
        layer.name = "Protected Areas"
    ) +
    m(
        geo_int_pa_ms_at_omv,
        col.regions = "tomato", alpha.regions = 0.7, # intersection
        color = "red",
        dashArray = "10,10",
        lwd = 2,
        layer.name = "Intersection"
    )
```

### Intersections by Protected Area Type (Interactive)

Click a row in the table to highlight the corresponding area on the map.

```{r}
# First, create the summarized data, unioning geometries by type
sf_intersections_by_type <- geo_intersections_areas %>%
  group_by(pa_DESIG_ENG, pa_DESIG) %>%
  summarise(
    total_area_sqkm = sum(area_intersection_sqkm, na.rm = TRUE),
    .groups = "drop"
  )

# Simplify the geometries to reduce file size and improve performance
# A tolerance of 100m is a good starting point
sf_intersections_by_type_simplified <- sf_intersections_by_type %>%
  st_simplify(dTolerance = 100)

# Wrap the data in a SharedData object for crosstalk
shared_intersections <- SharedData$new(sf_intersections_by_type_simplified)
```

::: {.panel-layout}
```{r}
# The Table
datatable(shared_intersections,
  extensions = "Buttons",
  options = list(
    dom = "Bfrtip",
    buttons = c("copy", "csv", "excel"),
    pageLength = 10
  ),
  rownames = FALSE
) %>%
  formatRound('total_area_sqkm', digits = 2)
```

```{r}
# The Map
leaflet(shared_intersections) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(
    weight = 2,
    fillOpacity = 0.7,
    color = "tomato",
    label = ~glue::glue("{pa_DESIG_ENG}: {round(units::drop_units(total_area_sqkm), 2)} sqkm")
  )
```
:::

# Which types of interscetion?

```{r}
options(scipen = 999)
geo_intersections_areas <- geo_int_pa_ms_at_omv %>%
    mutate(
        area_intersection_sqm = st_area(.),
        area_intersection_sqkm = st_area(.) / 1e6,
        area_intersection_ha = st_area(.) / 10000,
    )
```


